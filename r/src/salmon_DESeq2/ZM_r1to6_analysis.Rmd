

---
title: "Salmon Analysis - ZM_r1to6 "
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(DESeq2)
library("apeglm")
library("ashr")
library(EnhancedVolcano)
library(org.Hs.eg.db)
library("limma")

load("../../data/ZM_r1to6_data.RData")
dds
results <- results(dds)
resultsNames(dds)

add_annotations_to_results <- function(res) {
ens.str <- substr(rownames(res), 1, 15)
res$symbol <- mapIds(org.Hs.eg.db,
                    keys=ens.str,
                    column="SYMBOL",
                    keytype="ENSEMBL",
                    multiVals="first")
res$entrez <- mapIds(org.Hs.eg.db,
                    keys=ens.str,
                    column="ENTREZID",
                    keytype="ENSEMBL",
                    multiVals="first")
return (res)
}
```
        
# ZM Analysis {.tabset}



## Time -- ZM T0 to T16

### Unrestricted
#### Summary
```{r}
results_t16_t0 <- results(dds, contrast = c("timepoint", "t16", "t0"))

results_t16_t0 = add_annotations_to_results(results_t16_t0)

summary(results_t16_t0)

```

### Restricted
#### Summary
```{r}
results_t16_t0_restricted <-
results(
    dds,
    alpha = 0.1,
    ## We are looking for genes which have at least doubled, or decreased by more than half
    lfcThreshold = 1,
    contrast = c("timepoint", "t16", "t0")
)
summary(results_t16_t0_restricted)

```

#### MA Plot
```{r}

plotMA(results_t16_t0_restricted)
```

        

#### V- Plot

```{r}
results_t16_t0_restricted <- add_annotations_to_results(results_t16_t0_restricted)
selected_genes <- as.character(results_t16_t0_restricted$symbol)

EnhancedVolcano(results_t16_t0_restricted,
                lab = selected_genes,
                x = 'log2FoldChange',
                y = 'padj',
                xlim = c(-8,8),
                title = 'Differential expression',
                pCutoff = 0.05,
                FCcutoff = 1,
                pointSize = 3.0,
                labSize = 3.0)
```


### With LFC-Shrink
It is more useful visualize the MA-plot for the shrunken log2 fold changes, which remove the noise associated with log2 fold changes from low count genes without requiring arbitrary filtering thresholds.
#### APE GLM
```{r}

results_t16_t0_shrunk_apeglm <- lfcShrink(dds, coef="timepoint_t16_vs_t0", type="apeglm")
summary(results_t16_t0_shrunk_apeglm)

```


#### MA Plot
```{r}

plotMA(results_t16_t0_shrunk_apeglm)
```

        

#### V- Plot

```{r}
results_t16_t0_shrunk_apeglm <- add_annotations_to_results(results_t16_t0_shrunk_apeglm)
selected_genes <- as.character(results_t16_t0_shrunk_apeglm$symbol)

EnhancedVolcano(results_t16_t0_shrunk_apeglm,
                lab = selected_genes,
                x = 'log2FoldChange',
                y = 'padj',
                xlim = c(-8,8),
                title = 'Differential expression',
                pCutoff = 0.05,
                FCcutoff = 1,
                pointSize = 3.0,
                labSize = 3.0)
```


#### ashr
```{r}
results_t16_t0_shrunk_ashr <- lfcShrink(dds, coef="timepoint_t16_vs_t0", type="ashr")
summary(results_t16_t0_shrunk_ashr)

```


#### MA Plot
```{r}

plotMA(results_t16_t0_shrunk_ashr)
```

        

#### V- Plot

```{r}
results_t16_t0_shrunk_ashr <- add_annotations_to_results(results_t16_t0_shrunk_ashr)
selected_genes <- as.character(results_t16_t0_shrunk_ashr$symbol)

EnhancedVolcano(results_t16_t0_shrunk_ashr,
                lab = selected_genes,
                x = 'log2FoldChange',
                y = 'padj',
                xlim = c(-8,8),
                title = 'Differential expression',
                pCutoff = 0.05,
                FCcutoff = 1,
                pointSize = 3.0,
                labSize = 3.0)
```



### P-Adjusted Analysis
```{r}
resSig <- subset(results_t16_t0, padj < 0.1) 
summary(resSig)
```

### Strongest Down Regulated Genes
```{r}
head(resSig[ order(resSig$log2FoldChange), ])
```

### Strongest up regulation
```{r}
head(resSig[ order(resSig$log2FoldChange, decreasing = TRUE), ])
```
        
        



## Time -- ZM T0 to T20

### Unrestricted
#### Summary
```{r}
results_t20_t0 <- results(dds, contrast = c("timepoint", "t20", "t0"))

results_t20_t0 = add_annotations_to_results(results_t20_t0)

summary(results_t20_t0)

```

### Restricted
#### Summary
```{r}
results_t20_t0_restricted <-
results(
    dds,
    alpha = 0.1,
    ## We are looking for genes which have at least doubled, or decreased by more than half
    lfcThreshold = 1,
    contrast = c("timepoint", "t20", "t0")
)
summary(results_t20_t0_restricted)

```

#### MA Plot
```{r}

plotMA(results_t20_t0_restricted)
```

        

#### V- Plot

```{r}
results_t20_t0_restricted <- add_annotations_to_results(results_t20_t0_restricted)
selected_genes <- as.character(results_t20_t0_restricted$symbol)

EnhancedVolcano(results_t20_t0_restricted,
                lab = selected_genes,
                x = 'log2FoldChange',
                y = 'padj',
                xlim = c(-8,8),
                title = 'Differential expression',
                pCutoff = 0.05,
                FCcutoff = 1,
                pointSize = 3.0,
                labSize = 3.0)
```


### With LFC-Shrink
It is more useful visualize the MA-plot for the shrunken log2 fold changes, which remove the noise associated with log2 fold changes from low count genes without requiring arbitrary filtering thresholds.
#### APE GLM
```{r}

results_t20_t0_shrunk_apeglm <- lfcShrink(dds, coef="timepoint_t20_vs_t0", type="apeglm")
summary(results_t20_t0_shrunk_apeglm)

```


#### MA Plot
```{r}

plotMA(results_t20_t0_shrunk_apeglm)
```

        

#### V- Plot

```{r}
results_t20_t0_shrunk_apeglm <- add_annotations_to_results(results_t20_t0_shrunk_apeglm)
selected_genes <- as.character(results_t20_t0_shrunk_apeglm$symbol)

EnhancedVolcano(results_t20_t0_shrunk_apeglm,
                lab = selected_genes,
                x = 'log2FoldChange',
                y = 'padj',
                xlim = c(-8,8),
                title = 'Differential expression',
                pCutoff = 0.05,
                FCcutoff = 1,
                pointSize = 3.0,
                labSize = 3.0)
```


#### ashr
```{r}
results_t20_t0_shrunk_ashr <- lfcShrink(dds, coef="timepoint_t20_vs_t0", type="ashr")
summary(results_t20_t0_shrunk_ashr)

```


#### MA Plot
```{r}

plotMA(results_t20_t0_shrunk_ashr)
```

        

#### V- Plot

```{r}
results_t20_t0_shrunk_ashr <- add_annotations_to_results(results_t20_t0_shrunk_ashr)
selected_genes <- as.character(results_t20_t0_shrunk_ashr$symbol)

EnhancedVolcano(results_t20_t0_shrunk_ashr,
                lab = selected_genes,
                x = 'log2FoldChange',
                y = 'padj',
                xlim = c(-8,8),
                title = 'Differential expression',
                pCutoff = 0.05,
                FCcutoff = 1,
                pointSize = 3.0,
                labSize = 3.0)
```



### P-Adjusted Analysis
```{r}
resSig <- subset(results_t20_t0, padj < 0.1) 
summary(resSig)
```

### Strongest Down Regulated Genes
```{r}
head(resSig[ order(resSig$log2FoldChange), ])
```

### Strongest up regulation
```{r}
head(resSig[ order(resSig$log2FoldChange, decreasing = TRUE), ])
```
        
        



## Time -- ZM T0 to T24

### Unrestricted
#### Summary
```{r}
results_t24_t0 <- results(dds, contrast = c("timepoint", "t24", "t0"))

results_t24_t0 = add_annotations_to_results(results_t24_t0)

summary(results_t24_t0)

```

### Restricted
#### Summary
```{r}
results_t24_t0_restricted <-
results(
    dds,
    alpha = 0.1,
    ## We are looking for genes which have at least doubled, or decreased by more than half
    lfcThreshold = 1,
    contrast = c("timepoint", "t24", "t0")
)
summary(results_t24_t0_restricted)

```

#### MA Plot
```{r}

plotMA(results_t24_t0_restricted)
```

        

#### V- Plot

```{r}
results_t24_t0_restricted <- add_annotations_to_results(results_t24_t0_restricted)
selected_genes <- as.character(results_t24_t0_restricted$symbol)

EnhancedVolcano(results_t24_t0_restricted,
                lab = selected_genes,
                x = 'log2FoldChange',
                y = 'padj',
                xlim = c(-8,8),
                title = 'Differential expression',
                pCutoff = 0.05,
                FCcutoff = 1,
                pointSize = 3.0,
                labSize = 3.0)
```


### With LFC-Shrink
It is more useful visualize the MA-plot for the shrunken log2 fold changes, which remove the noise associated with log2 fold changes from low count genes without requiring arbitrary filtering thresholds.
#### APE GLM
```{r}

results_t24_t0_shrunk_apeglm <- lfcShrink(dds, coef="timepoint_t24_vs_t0", type="apeglm")
summary(results_t24_t0_shrunk_apeglm)

```


#### MA Plot
```{r}

plotMA(results_t24_t0_shrunk_apeglm)
```

        

#### V- Plot

```{r}
results_t24_t0_shrunk_apeglm <- add_annotations_to_results(results_t24_t0_shrunk_apeglm)
selected_genes <- as.character(results_t24_t0_shrunk_apeglm$symbol)

EnhancedVolcano(results_t24_t0_shrunk_apeglm,
                lab = selected_genes,
                x = 'log2FoldChange',
                y = 'padj',
                xlim = c(-8,8),
                title = 'Differential expression',
                pCutoff = 0.05,
                FCcutoff = 1,
                pointSize = 3.0,
                labSize = 3.0)
```


#### ashr
```{r}
results_t24_t0_shrunk_ashr <- lfcShrink(dds, coef="timepoint_t24_vs_t0", type="ashr")
summary(results_t24_t0_shrunk_ashr)

```


#### MA Plot
```{r}

plotMA(results_t24_t0_shrunk_ashr)
```

        

#### V- Plot

```{r}
results_t24_t0_shrunk_ashr <- add_annotations_to_results(results_t24_t0_shrunk_ashr)
selected_genes <- as.character(results_t24_t0_shrunk_ashr$symbol)

EnhancedVolcano(results_t24_t0_shrunk_ashr,
                lab = selected_genes,
                x = 'log2FoldChange',
                y = 'padj',
                xlim = c(-8,8),
                title = 'Differential expression',
                pCutoff = 0.05,
                FCcutoff = 1,
                pointSize = 3.0,
                labSize = 3.0)
```



### P-Adjusted Analysis
```{r}
resSig <- subset(results_t24_t0, padj < 0.1) 
summary(resSig)
```

### Strongest Down Regulated Genes
```{r}
head(resSig[ order(resSig$log2FoldChange), ])
```

### Strongest up regulation
```{r}
head(resSig[ order(resSig$log2FoldChange, decreasing = TRUE), ])
```
        
        



## Time -- ZM T0 to T36

### Unrestricted
#### Summary
```{r}
results_t36_t0 <- results(dds, contrast = c("timepoint", "t36", "t0"))

results_t36_t0 = add_annotations_to_results(results_t36_t0)

summary(results_t36_t0)

```

### Restricted
#### Summary
```{r}
results_t36_t0_restricted <-
results(
    dds,
    alpha = 0.1,
    ## We are looking for genes which have at least doubled, or decreased by more than half
    lfcThreshold = 1,
    contrast = c("timepoint", "t36", "t0")
)
summary(results_t36_t0_restricted)

```

#### MA Plot
```{r}

plotMA(results_t36_t0_restricted)
```

        

#### V- Plot

```{r}
results_t36_t0_restricted <- add_annotations_to_results(results_t36_t0_restricted)
selected_genes <- as.character(results_t36_t0_restricted$symbol)

EnhancedVolcano(results_t36_t0_restricted,
                lab = selected_genes,
                x = 'log2FoldChange',
                y = 'padj',
                xlim = c(-8,8),
                title = 'Differential expression',
                pCutoff = 0.05,
                FCcutoff = 1,
                pointSize = 3.0,
                labSize = 3.0)
```


### With LFC-Shrink
It is more useful visualize the MA-plot for the shrunken log2 fold changes, which remove the noise associated with log2 fold changes from low count genes without requiring arbitrary filtering thresholds.
#### APE GLM
```{r}

results_t36_t0_shrunk_apeglm <- lfcShrink(dds, coef="timepoint_t36_vs_t0", type="apeglm")
summary(results_t36_t0_shrunk_apeglm)

```


#### MA Plot
```{r}

plotMA(results_t36_t0_shrunk_apeglm)
```

        

#### V- Plot

```{r}
results_t36_t0_shrunk_apeglm <- add_annotations_to_results(results_t36_t0_shrunk_apeglm)
selected_genes <- as.character(results_t36_t0_shrunk_apeglm$symbol)

EnhancedVolcano(results_t36_t0_shrunk_apeglm,
                lab = selected_genes,
                x = 'log2FoldChange',
                y = 'padj',
                xlim = c(-8,8),
                title = 'Differential expression',
                pCutoff = 0.05,
                FCcutoff = 1,
                pointSize = 3.0,
                labSize = 3.0)
```


#### ashr
```{r}
results_t36_t0_shrunk_ashr <- lfcShrink(dds, coef="timepoint_t36_vs_t0", type="ashr")
summary(results_t36_t0_shrunk_ashr)

```


#### MA Plot
```{r}

plotMA(results_t36_t0_shrunk_ashr)
```

        

#### V- Plot

```{r}
results_t36_t0_shrunk_ashr <- add_annotations_to_results(results_t36_t0_shrunk_ashr)
selected_genes <- as.character(results_t36_t0_shrunk_ashr$symbol)

EnhancedVolcano(results_t36_t0_shrunk_ashr,
                lab = selected_genes,
                x = 'log2FoldChange',
                y = 'padj',
                xlim = c(-8,8),
                title = 'Differential expression',
                pCutoff = 0.05,
                FCcutoff = 1,
                pointSize = 3.0,
                labSize = 3.0)
```



### P-Adjusted Analysis
```{r}
resSig <- subset(results_t36_t0, padj < 0.1) 
summary(resSig)
```

### Strongest Down Regulated Genes
```{r}
head(resSig[ order(resSig$log2FoldChange), ])
```

### Strongest up regulation
```{r}
head(resSig[ order(resSig$log2FoldChange, decreasing = TRUE), ])
```
        
        



## Time -- ZM T0 to T48

### Unrestricted
#### Summary
```{r}
results_t48_t0 <- results(dds, contrast = c("timepoint", "t48", "t0"))

results_t48_t0 = add_annotations_to_results(results_t48_t0)

summary(results_t48_t0)

```
#### PCA Plots
##### Removing batch effect with Limma
```{r}
# plotPCA(dds, intgroup=c('batch', 'timepoint'))
lb_vsd <- vsd

mat <- assay(lb_vsd)
mm <- model.matrix(~timepoint, colData(lb_vsd))
mat <- limma::removeBatchEffect(mat, batch=lb_vsd$batch, design=mm)
assay(lb_vsd) <- mat
plotPCA(lb_vsd, intgroup=c('timepoint'))

```
```{r}
design <- model.matrix(~ timepoint, colData(lb_vsd))
fit <- lmFit(mat, design)

colnames(design)

# Replace 'treatment' and 'control' with your specific time points.
# Demonstrates difference between t0 and t48
contrast.matrix <- makeContrasts(timepointt48, levels=design)
fit2 <- contrasts.fit(fit, contrast.matrix)
fit2 <- eBayes(fit2)

results <- topTable(fit2, adjust.method="BH", number=Inf)
results <- add_annotations_to_results(results)
results_trimmed_na <- na.omit(results)
results_no_na <- results[!is.na(results$logFC), ]

results_ordered <- results_no_na[order(results_no_na$logFC), ]
results_ordered


```
```{r}
selected_genes <- as.character(results_t48_t0_restricted$symbol)

EnhancedVolcano(
    results,
    lab = selected_genes,
    x = 'logFC',
    y = 'adj.P.Val',
    title = 'Limma Batch effect Normalised ZM t0_t48',
    ylab = expression(paste('-Log'[10],' adj P')),       # Y-axis label
    # with adj p cutoff of 0.05
    pCutoff = 0.05,
    # at least double, or less than half
    FCcutoff = 1.0,
    pointSize = 3.0,
    labSize = 3.0
)

```

##### VSD
```{r}
vsd <- vst(dds, blind=FALSE)
plotPCA(vsd, intgroup=c('batch', 'timepoint'))

```
##### rLog
```{r}
rld <- rlog(dds, blind=FALSE)
plotPCA(rld, intgroup=c('batch', 'timepoint'))


```

### Restricted
#### Summary
```{r}
results_t48_t0_restricted <-
results(
    dds,
    alpha = 0.1,
    ## We are looking for genes which have at least doubled, or decreased by more than half
    lfcThreshold = 1,
    contrast = c("timepoint", "t48", "t0")
)
summary(results_t48_t0_restricted)

```

#### MA Plot
```{r}

plotMA(results_t48_t0_restricted)
```

        

#### V- Plot

```{r}
results_t48_t0_restricted <- add_annotations_to_results(results_t48_t0_restricted)
selected_genes <- as.character(results_t48_t0_restricted$symbol)

EnhancedVolcano(results_t48_t0_restricted,
                lab = selected_genes,
                x = 'log2FoldChange',
                y = 'padj',
                xlim = c(-8,8),
                title = 'Differential expression',
                pCutoff = 0.05,
                FCcutoff = 1,
                pointSize = 3.0,
                labSize = 3.0)
```


### With LFC-Shrink
It is more useful visualize the MA-plot for the shrunken log2 fold changes, which remove the noise associated with log2 fold changes from low count genes without requiring arbitrary filtering thresholds.
#### APE GLM
```{r}

results_t48_t0_shrunk_apeglm <- lfcShrink(dds, coef="timepoint_t48_vs_t0", type="apeglm")
summary(results_t48_t0_shrunk_apeglm)

```


#### MA Plot
```{r}

plotMA(results_t48_t0_shrunk_apeglm)
```

        

#### V- Plot

```{r}
results_t48_t0_shrunk_apeglm <- add_annotations_to_results(results_t48_t0_shrunk_apeglm)
selected_genes <- as.character(results_t48_t0_shrunk_apeglm$symbol)

EnhancedVolcano(results_t48_t0_shrunk_apeglm,
                lab = selected_genes,
                x = 'log2FoldChange',
                y = 'padj',
                xlim = c(-8,8),
                title = 'Differential expression',
                pCutoff = 0.05,
                FCcutoff = 1,
                pointSize = 3.0,
                labSize = 3.0)
```


#### ashr
```{r}
results_t48_t0_shrunk_ashr <- lfcShrink(dds, coef="timepoint_t48_vs_t0", type="ashr")
summary(results_t48_t0_shrunk_ashr)

```


#### MA Plot
```{r}

plotMA(results_t48_t0_shrunk_ashr)
```

        

#### V- Plot

```{r}
results_t48_t0_shrunk_ashr <- add_annotations_to_results(results_t48_t0_shrunk_ashr)
selected_genes <- as.character(results_t48_t0_shrunk_ashr$symbol)

EnhancedVolcano(results_t48_t0_shrunk_ashr,
                lab = selected_genes,
                x = 'log2FoldChange',
                y = 'padj',
                xlim = c(-8,8),
                title = 'Differential expression',
                pCutoff = 0.05,
                FCcutoff = 1,
                pointSize = 3.0,
                labSize = 3.0)
```



### P-Adjusted Analysis
```{r}
resSig <- subset(results_t48_t0, padj < 0.1) 
summary(resSig)
```

### Strongest Down Regulated Genes
```{r}
head(resSig[ order(resSig$log2FoldChange), ])
```

### Strongest up regulation
```{r}
head(resSig[ order(resSig$log2FoldChange, decreasing = TRUE), ])
```
        
        

